Bootstrap: docker
From: python:3.10-slim

%environment
  export PATH=/root/.local/bin:$PATH
  export DATA_PATH=/data
  export VIRTUAL_ENV_PATH=/code/.venv
  export PROFILE_PATH=$DATA_PATH/run-environment/profile

%files
  uv.lock /code/uv.lock
  pyproject.toml /code/pyproject.toml
  src /code/src
  scripts /code/scripts
  pipeline-steps.sh /code/pipeline-steps.sh
  README.md /code/README.md

%post
  export PATH=/root/.local/bin:$PATH
  export DATA_PATH=/data
  export PYTHONPATH=/code/src
  export VIRTUAL_ENV_PATH=/code/.venv

  # install uv for python dependency management
  apt-get update
  apt-get install --no-install-recommends curl git ffmpeg -y
  apt-get clean && rm -rf /var/lib/apt/lists/*

  mkdir /cargo
  curl -LsSf https://astral.sh/uv/install.sh | CARGO_HOME=/cargo sh
  echo "export PATH=/cargo/bin:\$PATH" >> $APPTAINER_ENVIRONMENT

  cd /code

  # install python dependencies
  uv venv $VIRTUAL_ENV_PATH
  . $VIRTUAL_ENV_PATH/bin/activate
  uv sync --no-cache --link-mode=copy

%runscript
  export GIT_COMMIT=$(git rev-parse HEAD)
  export PYTHONPATH=/code/src
  cd /code
  . $VIRTUAL_ENV_PATH/bin/activate
  ./pipeline-steps.sh

%labels
  Author nrs23@sussex.ac.uk, david.kadish@mau.se, k.a.gibb@sussex.ac.uk
  Version v0.0.1
